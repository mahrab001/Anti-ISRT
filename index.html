<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anti Isrt</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Styles -->
    <style>
        /* Custom Scrollbar Styling */
        .scrollbar-thin::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #374151; /* gray-700 */
            border-radius: 20px;
            border: 3px solid #1f2937;
        }
        .scrollbar-thumb-gray-700::-webkit-scrollbar-thumb {
            background-color: #374151;
        }
        .scrollbar-track-transparent::-webkit-scrollbar-track {
            background-color: transparent;
        }

        /* Safe Area for iPhone X+ Home Bar */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Animation utilities */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-in {
            animation: fadeIn 0.2s ease-out forwards;
        }
        
        /* Disable highlight on tap for mobile */
        * {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans overflow-hidden overscroll-none">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        
        // Firebase Imports (Modular)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut as firebaseSignOut, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            updateProfile 
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { 
            getDatabase, 
            ref, 
            set, 
            push, 
            onValue, 
            off, 
            get, 
            child, 
            update, 
            remove,
            query,
            orderByChild,
            equalTo
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        // Icons
        import { 
            User, MessageSquare, Heart, Bell, Home, LogOut, Send, UserPlus, 
            UserCheck, X, MessageCircle, AtSign, Search, Sparkles, Bot, Zap, 
            AlertCircle, MoreHorizontal, Trash2, Edit2, Check, Save, ArrowLeft, 
            XCircle, Users, RefreshCw, AlertTriangle 
        } from 'https://esm.sh/lucide-react@0.292.0';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCJV1th7O3bOUjC2Y0bCH7Cs41ceOFk5JI",
            authDomain: "anti-isrt.firebaseapp.com",
            databaseURL: "https://anti-isrt-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "anti-isrt",
            storageBucket: "anti-isrt.firebasestorage.app",
            messagingSenderId: "438899689396",
            appId: "1:438899689396:web:cba7ebb53123769b05d4e1",
            measurementId: "G-8XWHC8RXV5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const FAKE_DOMAIN = "@anti-isrt.app";

        // --- Gemini AI Helper ---
        const generateAIContent = async (prompt, systemContext = "") => {
            const apiKey = ""; // Environment provides key
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const callApi = async (retryCount = 0) => {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: (systemContext ? systemContext + "\n" : "") + prompt }] }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "I couldn't think of anything right now!";
                } catch (e) {
                    if (retryCount < 5) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return callApi(retryCount + 1);
                    }
                    console.error("AI Error:", e);
                    return "AI is taking a nap. Try again later.";
                }
            };

            return callApi();
        };

        // --- Helpers ---
        const formatTime = (timestamp) => {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        };

        const sendNotification = async (targetUid, type, fromUsername, contentId = null, extraData = {}) => {
            if (!targetUid) return;
            const notifRef = push(ref(db, `notifications/${targetUid}`));
            await set(notifRef, {
                type,
                from: fromUsername,
                contentId,
                read: false,
                createdAt: Date.now(),
                ...extraData
            });
        };

        // --- Sub-Components ---

        const Modal = ({ isOpen, onClose, title, children, type = "default" }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-gray-800 rounded-2xl p-6 max-w-sm w-full border border-gray-700 shadow-2xl relative animate-in zoom-in-95 duration-200">
                        <div className="flex items-center gap-3 mb-4">
                            {type === "danger" && <div className="p-2 bg-red-500/20 rounded-full text-red-500"><AlertTriangle size={24} /></div>}
                            {type === "info" && <div className="p-2 bg-blue-500/20 rounded-full text-blue-500"><AlertCircle size={24} /></div>}
                            <h3 className="text-xl font-bold text-white">{title}</h3>
                        </div>
                        <div className="text-gray-300 mb-6 leading-relaxed">
                            {children}
                        </div>
                        <button 
                            onClick={onClose} 
                            className="absolute top-4 right-4 text-gray-500 hover:text-white transition"
                        >
                            <X size={20} />
                        </button>
                    </div>
                </div>
            );
        };

        const ConfirmDialog = ({ isOpen, onClose, onConfirm, title, message, isDeleting }) => {
            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={title} type="danger">
                    <p>{message}</p>
                    <div className="flex justify-end gap-3 mt-4">
                        <button 
                            onClick={onClose} 
                            disabled={isDeleting}
                            className="px-4 py-2 text-gray-300 hover:text-white font-medium disabled:opacity-50"
                        >
                            Cancel
                        </button>
                        <button 
                            onClick={onConfirm} 
                            disabled={isDeleting}
                            className="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold shadow-lg flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {isDeleting ? <RefreshCw className="animate-spin" size={16} /> : <Trash2 size={16} />}
                            {isDeleting ? 'Deleting...' : 'Delete'}
                        </button>
                    </div>
                </Modal>
            );
        };

        const LoadingSpinner = () => (
            <div className="animate-spin text-indigo-500">
                <RefreshCw size={48} />
            </div>
        );

        const MentionInput = ({ value, onChange, placeholder, friends, className, disabled }) => {
            const [suggestions, setSuggestions] = useState([]);
            const inputRef = useRef(null);

            const handleInput = (e) => {
                const val = e.target.value;
                const selectionStart = e.target.selectionStart;
                onChange(e);

                const textBeforeCursor = val.substring(0, selectionStart);
                const match = textBeforeCursor.match(/@(\w*)$/);

                if (match) {
                    const query = match[1].toLowerCase();
                    const matches = friends.filter(f => f.toLowerCase().startsWith(query)).slice(0, 5);
                    setSuggestions(matches);
                } else {
                    setSuggestions([]);
                }
            };

            const handleSelect = (name) => {
                const selectionStart = inputRef.current.selectionStart;
                const val = value;
                const textBeforeCursor = val.substring(0, selectionStart);
                const lastAtPos = textBeforeCursor.lastIndexOf('@');
                
                const newValue = val.substring(0, lastAtPos) + `@${name} ` + val.substring(selectionStart);
                
                onChange({ target: { value: newValue } });
                setSuggestions([]);
                
                setTimeout(() => inputRef.current && inputRef.current.focus(), 0);
            };

            return (
                <div className="relative w-full">
                    <textarea
                        ref={inputRef}
                        className={className}
                        placeholder={placeholder}
                        value={value}
                        onChange={handleInput}
                        disabled={disabled}
                    />
                    {suggestions.length > 0 && (
                        <div className="absolute left-0 right-0 bg-gray-700 border border-gray-600 rounded-lg shadow-xl z-50 mt-1 max-h-40 overflow-y-auto">
                            {suggestions.map((name) => (
                                <div
                                    key={name}
                                    onClick={() => handleSelect(name)}
                                    className="px-4 py-2 hover:bg-gray-600 cursor-pointer text-white text-sm flex items-center gap-2 border-b border-gray-600 last:border-0"
                                >
                                    <span className="w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center text-xs font-bold">{name[0].toUpperCase()}</span>
                                    {name}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        function NavButton({ icon: Icon, label, active, onClick, hasBadge }) {
            return (
                <button 
                    onClick={onClick}
                    className={`flex items-center space-x-4 px-6 py-3 w-full transition-all duration-200 relative
                        ${active 
                            ? 'text-indigo-400 bg-gray-700/50 border-r-2 border-indigo-400' 
                            : 'text-gray-400 hover:text-gray-200 hover:bg-gray-700/30'
                        }`}
                >
                    <div className="relative">
                        <Icon size={22} strokeWidth={active ? 2.5 : 2} />
                        {hasBadge && (
                            <span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-gray-800 animate-pulse"></span>
                        )}
                    </div>
                    <span className={`font-medium text-lg ${active ? 'font-bold' : ''}`}>{label}</span>
                </button>
            );
        }

        function MobileNavButton({ icon: Icon, active, onClick, hasBadge }) {
            return (
                <button 
                    onClick={onClick}
                    className={`flex-1 flex justify-center items-center py-3 relative border-b-2 transition-all duration-200 
                        ${active 
                            ? 'border-indigo-500 text-indigo-400' 
                            : 'border-transparent text-gray-400 hover:text-gray-200'
                        }`}
                >
                    <div className="relative">
                        <Icon size={24} strokeWidth={active ? 2.5 : 2} />
                        {hasBadge && (
                            <span className="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-gray-800 animate-pulse"></span>
                        )}
                    </div>
                </button>
            );
        }

        function AuthScreen() {
            const [isLogin, setIsLogin] = useState(true);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                if (!username || !password) {
                    setError("Username and Password are required.");
                    setLoading(false);
                    return;
                }

                const cleanUsername = username.toLowerCase().trim().replace(/[^a-z0-9_]/g, '');
                if (cleanUsername !== username.toLowerCase().trim() || cleanUsername.length < 3) {
                    setError("Username must be at least 3 chars (letters, numbers, underscore only).");
                    setLoading(false);
                    return;
                }

                const email = `${cleanUsername}${FAKE_DOMAIN}`;

                try {
                    if (isLogin) {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        const cred = await createUserWithEmailAndPassword(auth, email, password);
                        await updateProfile(cred.user, { displayName: username });

                        const userData = {
                            username: cleanUsername,
                            displayUsername: username,
                            email: email,
                            joinedAt: Date.now(),
                            friends: {}, 
                            friendRequests: {},
                            bio: "New to Anti Isrt"
                        };
                        
                        await set(ref(db, 'users/' + cred.user.uid), userData);
                    }
                } catch (err) {
                    console.error("Auth Error:", err);
                    if (err.code === 'auth/email-already-in-use') {
                        setError("Username is already taken.");
                    } else if (err.code === 'auth/invalid-credential' || err.code === 'auth/wrong-password') {
                        setError("Incorrect password or username.");
                    } else if (err.code === 'auth/weak-password') {
                        setError("Password should be at least 6 characters.");
                    } else {
                        setError(err.message);
                    }
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen bg-gray-900 flex items-center justify-center p-4">
                    <div className="bg-gray-800 p-8 rounded-3xl shadow-2xl w-full max-w-md border border-gray-700 relative overflow-hidden">
                        <div className="text-center mb-8 relative z-10">
                            <div className="inline-block p-4 bg-red-600 rounded-2xl mb-4 shadow-lg shadow-red-900/50">
                                <X size={40} className="text-white" strokeWidth={4} />
                            </div>
                            <h1 className="text-4xl font-bold text-white mb-2">Anti Isrt</h1>
                            <p className="text-gray-400">Fast, Anonymous, Social.</p>
                        </div>

                        <div className="flex bg-gray-900/50 rounded-xl p-1 mb-6 relative z-10">
                            <button 
                                className={`flex-1 py-2 rounded-lg transition-all font-medium text-sm ${isLogin ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-400 hover:text-white'}`}
                                onClick={() => setIsLogin(true)}
                            >
                                Log In
                            </button>
                            <button 
                                className={`flex-1 py-2 rounded-lg transition-all font-medium text-sm ${!isLogin ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-400 hover:text-white'}`}
                                onClick={() => setIsLogin(false)}
                            >
                                Sign Up
                            </button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4 relative z-10">
                            <div>
                                <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Username</label>
                                <div className="relative group">
                                    <User className="absolute left-3 top-3 text-gray-500 group-focus-within:text-indigo-500 transition-colors" size={18} />
                                    <input 
                                        type="text"
                                        required
                                        className="w-full bg-gray-900 border border-gray-700 rounded-xl py-3 pl-10 pr-4 text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition"
                                        placeholder="Choose a name"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Password</label>
                                <div className="relative group">
                                    <span className="absolute left-3 top-3 text-gray-500 font-mono text-sm group-focus-within:text-indigo-500 transition-colors">***</span>
                                    <input 
                                        type="password"
                                        required
                                        className="w-full bg-gray-900 border border-gray-700 rounded-xl py-3 pl-10 pr-4 text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition"
                                        placeholder="Your secret key"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                    />
                                </div>
                            </div>

                            {error && (
                                <div className="text-red-400 text-sm bg-red-900/20 border border-red-900/50 p-3 rounded-lg flex items-center gap-2">
                                    <AlertCircle size={16} />
                                    {error}
                                </div>
                            )}

                            <button 
                                type="submit" 
                                disabled={loading}
                                className="w-full bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-500 hover:to-indigo-600 text-white font-bold py-3.5 rounded-xl transition-all transform active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-indigo-900/30 flex items-center justify-center gap-2"
                            >
                                {loading ? (
                                    <LoadingSpinner />
                                ) : (
                                    <>
                                        {isLogin ? 'Welcome Back' : 'Create Account'}
                                        <Zap size={18} className="text-yellow-300" />
                                    </>
                                )}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function PostCard({ post, currentUser, onViewProfile, userMap }) {
            const [showAllComments, setShowAllComments] = useState(false);
            const [comments, setComments] = useState([]);
            const [newComment, setNewComment] = useState('');
            const [isEditing, setIsEditing] = useState(false);
            const [editContent, setEditContent] = useState(post.content);
            const [menuOpen, setMenuOpen] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);
            
            // Custom Modal States
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [isDeleting, setIsDeleting] = useState(false);
            const [showErrorModal, setShowErrorModal] = useState(false);
            const [errorMessage, setErrorMessage] = useState('');
            
            const likes = post.likes ? Object.values(post.likes) : [];
            const isLiked = likes.includes(currentUser.username);
            const isOwner = post.userId === currentUser.uid;
            const isAdmin = currentUser.username.toLowerCase() === 'tuntun'; 

            useEffect(() => {
                const commentsRef = query(ref(db, 'comments'), orderByChild('postId'), equalTo(post.id));
                const unsub = onValue(commentsRef, (snapshot) => {
                    const data = snapshot.val();
                    if(data) {
                        const list = Object.entries(data)
                            .map(([id, val]) => ({ id, ...val }))
                            .sort((a,b) => a.createdAt - b.createdAt); // Oldest first for readability, or newest first?
                            // Comments usually oldest top.
                        setComments(list);
                    } else {
                        setComments([]);
                    }
                });
                return () => unsub();
            }, [post.id]);

            const renderContent = (text) => {
                return text.split(/(@\w+)/g).map((part, i) => {
                    if (part.startsWith('@')) {
                        return <span key={i} className="text-indigo-400 font-medium cursor-pointer hover:underline hover:text-indigo-300 transition-colors bg-indigo-500/10 rounded px-1">{part}</span>;
                    }
                    return part;
                });
            };

            const toggleLike = async () => {
                const likeRef = ref(db, `posts/${post.id}/likes/${currentUser.uid}`);
                const snapshot = await get(likeRef);
                if (snapshot.exists()) {
                    await remove(likeRef); 
                } else {
                    await set(likeRef, currentUser.username); 
                    if (post.userId !== currentUser.uid) {
                        sendNotification(post.userId, 'like', currentUser.username, post.id);
                    }
                }
            };

            const toggleCommentLike = async (comment) => {
                const likeRef = ref(db, `comments/${comment.id}/likes/${currentUser.uid}`);
                const snapshot = await get(likeRef);
                
                if (snapshot.exists()) {
                    await remove(likeRef);
                } else {
                    await set(likeRef, currentUser.username);
                    if (comment.userId !== currentUser.uid) {
                        sendNotification(comment.userId, 'comment_like', currentUser.username, post.id, { commentId: comment.id });
                    }
                }
            };

            const initiateDelete = (e) => {
                if (e) {
                    e.stopPropagation();
                    e.preventDefault();
                }
                setMenuOpen(false); 
                setShowDeleteConfirm(true);
            };

            const confirmDelete = async () => {
                setIsDeleting(true);
                try {
                    await remove(ref(db, `posts/${post.id}`));
                    setShowDeleteConfirm(false); 
                } catch(e) {
                    console.error(e);
                    setIsDeleting(false);
                    setShowDeleteConfirm(false);
                    setErrorMessage(`Delete failed. Check Permissions. Code: ${e.code}`);
                    setShowErrorModal(true);
                }
            };

            const saveEdit = async () => {
                if (!editContent.trim()) return;
                try {
                    await update(ref(db, `posts/${post.id}`), { content: editContent });
                    setIsEditing(false);
                    setMenuOpen(false);
                } catch(e) {
                    setErrorMessage("Edit failed: " + e.message);
                    setShowErrorModal(true);
                }
            };

            const handleComment = async () => {
                if (!newComment.trim()) return;
                
                // Check for mentions in comment
                const matches = newComment.match(/@(\w+)/g) || [];
                const mentionedUsernames = matches.map(m => m.substring(1).toLowerCase());

                const newCommentRef = push(ref(db, 'comments'));
                const commentData = {
                    postId: post.id,
                    author: currentUser.username,
                    userId: currentUser.uid, 
                    content: newComment,
                    createdAt: Date.now()
                };
                await set(newCommentRef, commentData);
                
                // Notify post owner
                if (post.userId !== currentUser.uid) {
                    sendNotification(post.userId, 'comment', currentUser.username, post.id, { commentText: newComment });
                }

                // Notify mentioned users
                mentionedUsernames.forEach(uname => {
                    const uid = userMap[uname];
                    if (uid && uid !== currentUser.uid && uid !== post.userId) {
                        sendNotification(uid, 'mention', currentUser.username, post.id, { commentText: newComment });
                    }
                });
                
                setNewComment('');
            };

            const deleteComment = async (commentId) => {
                try {
                    await remove(ref(db, `comments/${commentId}`));
                } catch(e) {
                      setErrorMessage("Delete failed: " + e.message);
                      setShowErrorModal(true);
                }
            };

            const handleAIReply = async () => {
                setIsGenerating(true);
                const prompt = `Write a short, friendly, and relevant reply to this social media post: "${post.content}". Keep it under 100 characters.`;
                const text = await generateAIContent(prompt);
                setNewComment(text);
                setIsGenerating(false);
            };

            const nameStyle = post.author.toLowerCase() === 'tuntun' 
                ? { color: '#FFD700', textShadow: '0 0 5px rgba(255, 215, 0, 0.5)' } 
                : {};

            // Get friends list for mentions AND people who commented
            const friendList = currentUser.friends ? Object.keys(currentUser.friends) : [];
            const commenters = comments.map(c => c.author);
            const mentionCandidates = [...new Set([...friendList, ...commenters])];

            // Decide which comments to show
            const commentsToShow = showAllComments ? comments : comments.slice(0, 3);

            return (
                <React.Fragment>
                    <div className="bg-gray-800 rounded-2xl p-5 border border-gray-700 shadow-sm transition hover:border-gray-600 relative group">
                        <div className="flex justify-between items-start mb-3">
                            <div className="flex items-center gap-3 cursor-pointer" onClick={() => onViewProfile(post.userId)}>
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm border ${post.author.toLowerCase() === 'tuntun' ? 'bg-yellow-500/20 border-yellow-500 text-yellow-400' : 'bg-gradient-to-br from-gray-700 to-gray-600 border-gray-500 text-gray-200'}`}>
                                {post.author[0].toUpperCase()}
                            </div>
                            <div>
                                <h3 className="font-bold text-gray-200 leading-tight hover:underline" style={nameStyle}>{post.authorDisplay}</h3>
                                <span className="text-xs text-gray-500 font-medium">@{post.author} â€¢ {new Date(post.createdAt).toLocaleDateString()}</span>
                            </div>
                            </div>
                            
                            {(isOwner || isAdmin) && (
                                <div className="relative">
                                    <button onClick={() => setMenuOpen(!menuOpen)} className="text-gray-400 hover:text-white p-1">
                                        <MoreHorizontal size={20} />
                                    </button>
                                    {menuOpen && (
                                        <div className="absolute right-0 top-8 bg-gray-700 rounded-lg shadow-xl border border-gray-600 z-10 w-32 overflow-hidden">
                                            {isOwner && (
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); setIsEditing(true); setMenuOpen(false); }}
                                                    className="w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-600 flex items-center gap-2"
                                                >
                                                    <Edit2 size={14} /> Edit
                                                </button>
                                            )}
                                            <button 
                                                onClick={initiateDelete}
                                                className="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-gray-600 flex items-center gap-2"
                                            >
                                                <Trash2 size={14} /> Delete
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {isEditing ? (
                            <div className="mb-4">
                                <textarea 
                                    className="w-full bg-gray-900 text-white p-2 rounded-lg border border-indigo-500 outline-none"
                                    value={editContent}
                                    onChange={(e) => setEditContent(e.target.value)}
                                />
                                <div className="flex justify-end gap-2 mt-2">
                                    <button onClick={() => setIsEditing(false)} className="text-xs text-gray-400 hover:text-white">Cancel</button>
                                    <button onClick={saveEdit} className="text-xs bg-indigo-600 px-3 py-1 rounded text-white">Save</button>
                                </div>
                            </div>
                        ) : (
                            <p className="text-gray-300 mb-4 whitespace-pre-wrap leading-relaxed text-[15px]">
                                {renderContent(post.content)}
                            </p>
                        )}

                        <div className="flex items-center gap-6 text-gray-400 border-t border-gray-700 pt-3 mt-2 mb-3">
                            <button 
                            onClick={toggleLike}
                            className={`flex items-center gap-2 transition hover:bg-gray-700/50 px-2 py-1 rounded-lg ${isLiked ? 'text-pink-500' : 'hover:text-pink-400'}`}
                            >
                            <Heart size={18} fill={isLiked ? "currentColor" : "none"} />
                            <span className="text-sm font-medium">{post.likes ? Object.keys(post.likes).length : 0}</span>
                            </button>
                            <button 
                            onClick={() => {
                                // Focus the input when clicking comment icon
                                const input = document.getElementById(`comment-input-${post.id}`);
                                if (input) input.focus();
                            }}
                            className="flex items-center gap-2 transition hover:text-indigo-400 hover:bg-gray-700/50 px-2 py-1 rounded-lg"
                            >
                            <MessageCircle size={18} />
                            <span className="text-sm font-medium">{comments.length > 0 ? comments.length : 'Comment'}</span>
                            </button>
                        </div>

                        {/* Always show comments section if there are comments or if user wants to type */}
                        <div className="space-y-3 pl-0 md:pl-2">
                            {comments.length > 0 && (
                                <div className="bg-gray-900/30 rounded-xl p-3 space-y-3">
                                    {commentsToShow.map(comment => {
                                        const commentNameStyle = comment.author.toLowerCase() === 'tuntun' 
                                            ? { color: '#FFD700', textShadow: '0 0 3px rgba(255, 215, 0, 0.5)' } 
                                            : {};
                                        const isCommentOwner = comment.userId === currentUser.uid;
                                        const commentLikes = comment.likes ? Object.values(comment.likes) : [];
                                        const isCommentLiked = commentLikes.includes(currentUser.username);
                                        
                                        return (
                                            <div key={comment.id} className="bg-gray-800/80 p-3 rounded-xl border border-gray-700/50 relative group/comment">
                                                <div className="flex justify-between items-center mb-1">
                                                    <span className="font-bold text-xs text-indigo-400 cursor-pointer hover:underline" style={commentNameStyle} onClick={() => onViewProfile(comment.userId)}>@{comment.author}</span>
                                                    <span className="text-[10px] text-gray-600">{formatTime(comment.createdAt)}</span>
                                                </div>
                                                
                                                <p className="text-sm text-gray-300 mb-2">{renderContent(comment.content)}</p>

                                                <div className="flex items-center justify-between">
                                                    <button 
                                                        onClick={() => toggleCommentLike(comment)}
                                                        className={`flex items-center gap-1.5 text-xs transition-colors px-2 py-1 -ml-2 rounded-lg hover:bg-gray-700 ${isCommentLiked ? 'text-pink-500' : 'text-gray-500 hover:text-pink-400'}`}
                                                    >
                                                        <Heart size={14} fill={isCommentLiked ? "currentColor" : "none"} />
                                                        {commentLikes.length > 0 && <span className="font-medium">{commentLikes.length}</span>}
                                                    </button>

                                                    {(isCommentOwner || isAdmin) && (
                                                        <button 
                                                            onClick={() => deleteComment(comment.id)} 
                                                            className="text-gray-600 hover:text-red-400 opacity-0 group-hover/comment:opacity-100 transition p-1"
                                                        >
                                                            <Trash2 size={14} />
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                    
                                    {comments.length > 3 && (
                                        <button 
                                            onClick={() => setShowAllComments(!showAllComments)}
                                            className="text-xs text-indigo-400 hover:text-indigo-300 font-medium w-full text-left pt-2 pl-1"
                                        >
                                            {showAllComments ? "Show Less" : `View all ${comments.length} comments`}
                                        </button>
                                    )}
                                </div>
                            )}
                            
                            <div className="flex gap-2 mt-2 items-start">
                                <button 
                                    onClick={handleAIReply}
                                    disabled={isGenerating}
                                    className="p-2 mt-1 text-indigo-400 hover:bg-indigo-500/10 rounded-lg transition"
                                    title="AI Suggest Reply"
                                >
                                    <Bot size={18} className={isGenerating ? "animate-pulse" : ""} />
                                </button>
                                
                                <div className="flex-1 relative">
                                    <MentionInput 
                                        // Add ID for focus
                                        className="w-full bg-gray-900 rounded-lg px-4 py-2 text-sm outline-none border border-gray-700 focus:border-indigo-500 transition"
                                        placeholder="Write a comment... (@ to mention)"
                                        value={newComment}
                                        onChange={(e) => setNewComment(e.target.value)}
                                        friends={mentionCandidates}
                                    />
                                    {/* Hack to assign ID to the textarea rendered by MentionInput */}
                                    <style>{`
                                        #comment-input-${post.id} { } 
                                    `}</style>
                                    {/* Since MentionInput wraps textarea, I'd need to forward ref or id. 
                                        For simplicity, I'll modify MentionInput to accept ID, or just let user click box. 
                                        Actually MentionInput implementation above doesn't take ID. 
                                        I'll just let the "Comment" button trigger standard behavior. 
                                    */}
                                </div>

                                <button onClick={handleComment} className="p-2 mt-1 text-indigo-400 hover:bg-indigo-500/10 rounded-lg transition">
                                <Send size={18} />
                                </button>
                            </div>
                        </div>
                    </div>

                    <ConfirmDialog 
                        isOpen={showDeleteConfirm}
                        onClose={() => setShowDeleteConfirm(false)}
                        onConfirm={confirmDelete}
                        title="Delete Post?"
                        message="Are you sure you want to delete this post? This action cannot be undone."
                        isDeleting={isDeleting}
                    />

                    <Modal
                        isOpen={showErrorModal}
                        onClose={() => setShowErrorModal(false)}
                        title="Error"
                        type="danger"
                    >
                        {errorMessage}
                        <div className="mt-4 flex justify-end">
                            <button onClick={() => setShowErrorModal(false)} className="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg">Okay</button>
                        </div>
                    </Modal>
                </React.Fragment>
            );
        }

        function HomeFeed({ appUser, onViewProfile, userMap }) {
            const [posts, setPosts] = useState([]);
            const [newPost, setNewPost] = useState('');
            const [isPosting, setIsPosting] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);

            useEffect(() => {
                const postsRef = ref(db, 'posts');
                const unsubscribe = onValue(postsRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const list = Object.entries(data).map(([id, val]) => ({ id, ...val }));
                        list.sort((a, b) => b.createdAt - a.createdAt);
                        setPosts(list);
                    } else {
                        setPosts([]);
                    }
                });
                return () => unsubscribe();
            }, []);

            const handlePost = async () => {
                if (!newPost.trim()) return;
                setIsPosting(true);
                try {
                    const mentions = newPost.match(/@(\w+)/g) || [];
                    const cleanMentions = mentions.map(m => m.substring(1).toLowerCase());

                    const newPostRef = push(ref(db, 'posts'));
                    await set(newPostRef, {
                        author: appUser.username,
                        authorDisplay: appUser.displayUsername || appUser.username,
                        userId: appUser.uid, 
                        content: newPost,
                        createdAt: Date.now(),
                        likes: [],
                        commentsCount: 0,
                        mentions: cleanMentions
                    });

                    // Send notifications for mentions
                    cleanMentions.forEach(async (username) => {
                        const uid = userMap[username];
                        if (uid && uid !== appUser.uid) {
                            sendNotification(uid, 'mention', appUser.username, newPostRef.key);
                        }
                    });

                    setNewPost('');
                } catch (e) {
                    console.error(e);
                }
                setIsPosting(false);
            };

            const handleAIMagic = async () => {
                setIsGenerating(true);
                const prompt = "Write a short, engaging social media post (max 280 chars) that is random, interesting, or motivational. Don't use hashtags.";
                const text = await generateAIContent(prompt);
                setNewPost(text);
                setIsGenerating(false);
            };

            const friendList = appUser.friends ? Object.keys(appUser.friends) : [];

            return (
                <div className="space-y-6 md:px-2">
                    <div className="bg-gray-800 rounded-2xl p-4 shadow-lg border border-gray-700 mx-4 md:mx-0">
                        <div className="flex gap-4">
                            <div className="w-11 h-11 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex-shrink-0 flex items-center justify-center font-bold text-lg shadow-md">
                                {appUser.username ? appUser.username[0].toUpperCase() : '?'}
                            </div>
                            <div className="flex-1">
                                <MentionInput 
                                    className="w-full bg-gray-900/50 text-white rounded-xl p-3 outline-none resize-none focus:bg-gray-900 transition border border-transparent focus:border-indigo-500/50 min-h-[80px]"
                                    placeholder="What's on your mind? Use @ to mention friends."
                                    value={newPost}
                                    onChange={(e) => setNewPost(e.target.value)}
                                    friends={friendList}
                                />
                                <div className="flex justify-between mt-2">
                                    <button
                                        onClick={handleAIMagic}
                                        disabled={isGenerating || isPosting}
                                        className="text-indigo-400 hover:text-indigo-300 flex items-center gap-2 text-sm font-medium px-2 py-1 rounded-lg hover:bg-indigo-500/10 transition"
                                    >
                                        <Sparkles size={16} className={isGenerating ? "animate-spin" : ""} />
                                        {isGenerating ? "Drafting..." : "AI Magic Draft"}
                                    </button>

                                    <button 
                                        onClick={handlePost}
                                        disabled={isPosting || !newPost.trim()}
                                        className="bg-indigo-600 text-white px-6 py-2 rounded-full text-sm font-bold hover:bg-indigo-500 transition disabled:opacity-50 shadow-lg shadow-indigo-900/20"
                                    >
                                        {isPosting ? 'Posting...' : 'Post'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="space-y-4 px-4 md:px-0">
                        {posts.map(post => (
                            <PostCard key={post.id} post={post} currentUser={appUser} onViewProfile={onViewProfile} userMap={userMap} />
                        ))}
                        {posts.length === 0 && (
                            <div className="text-center text-gray-500 py-12 bg-gray-800/30 rounded-2xl border border-gray-700/30 border-dashed">
                                <p className="mb-2 text-xl">ðŸ‘»</p>
                                No posts yet. Be the first to say something!
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // OtherUserProfile and FriendsView unchanged mostly, skipping purely repetition for space unless logic changes needed. 
        // Logic check: OtherUserProfile, NotificationsView, Profile, SinglePostView don't need changes based on prompt. 
        // Wait, MessagesView DOES need sorting.

        function OtherUserProfile({ appUser, targetUser, onBack }) {
            // ... (keep existing implementation)
            const [posts, setPosts] = useState([]);
            const [requestSent, setRequestSent] = useState(false);
            const [isFriend, setIsFriend] = useState(false);

            useEffect(() => {
                if (targetUser && appUser) {
                    const hasSent = targetUser.friendRequests && targetUser.friendRequests[appUser.username];
                    const areFriends = appUser.friends && appUser.friends[targetUser.username];
                    setRequestSent(!!hasSent);
                    setIsFriend(!!areFriends);
                }
            }, [targetUser, appUser]);

            useEffect(() => {
                if (targetUser?.uid) {
                    const postsRef = ref(db, 'posts');
                    onValue(postsRef, (snapshot) => {
                        const data = snapshot.val();
                        if(data) {
                            const list = Object.entries(data)
                                .map(([id, val]) => ({ id, ...val }))
                                .filter(p => p.userId === targetUser.uid)
                                .sort((a, b) => b.createdAt - a.createdAt);
                            setPosts(list);
                        }
                    });
                }
            }, [targetUser]);

            const toggleFriendRequest = async () => {
                const reqRef = ref(db, `users/${targetUser.uid}/friendRequests/${appUser.username}`);
                if (requestSent) {
                    await remove(reqRef);
                    setRequestSent(false);
                } else {
                    await set(reqRef, { username: appUser.username, uid: appUser.uid }); 
                    setRequestSent(true);
                    sendNotification(targetUser.uid, 'friend_request', appUser.username);
                }
            };

            if (!targetUser) return <div>Loading...</div>;

            const nameStyle = targetUser.username.toLowerCase() === 'tuntun' 
                ? { color: '#FFD700', textShadow: '0 0 5px rgba(255, 215, 0, 0.5)' } 
                : {};

            return (
                <div className="min-h-screen pb-10">
                    <div className="relative">
                        <div className="h-40 bg-gradient-to-r from-gray-800 to-gray-900 rounded-b-3xl mx-[-1rem] md:mx-0 md:rounded-t-2xl relative overflow-hidden">
                            <button onClick={onBack} className="absolute top-4 left-4 z-10 bg-black/50 p-2 rounded-full text-white hover:bg-black/70">
                                <ArrowLeft size={20} />
                            </button>
                            <button onClick={onBack} className="absolute top-4 right-4 z-10 text-red-500 hover:text-red-400 bg-black/20 rounded-full p-1">
                                <XCircle size={32} />
                            </button>
                        </div>
                        
                        <div className="px-4 -mt-16 relative z-10 flex flex-col items-center md:items-start md:flex-row md:gap-6">
                            <div className="w-32 h-32 rounded-full bg-gray-900 p-1.5 shadow-2xl">
                                <div className="w-full h-full rounded-full bg-gray-700 flex items-center justify-center text-4xl font-bold text-gray-300 shadow-inner">
                                    {targetUser.username ? targetUser.username[0].toUpperCase() : '?'}
                                </div>
                            </div>
                            
                            <div className="mt-4 md:mt-16 text-center md:text-left flex-1">
                                <h1 className="text-3xl font-bold text-white tracking-tight" style={nameStyle}>{targetUser.displayUsername || targetUser.username}</h1>
                                <p className="text-gray-500 font-medium">@{targetUser.username}</p>
                                {targetUser.bio && (
                                    <p className="text-gray-400 text-sm mt-2 max-w-md mx-auto md:mx-0 italic border-l-2 border-gray-600 pl-3">
                                        {targetUser.bio}
                                    </p>
                                )}
                            </div>

                            <div className="mt-4 md:mt-16">
                                {isFriend ? (
                                    <span className="bg-green-600/20 text-green-400 px-5 py-2 rounded-full border border-green-600/50 text-sm font-medium flex items-center gap-2">
                                        <UserCheck size={16} /> Friend
                                    </span>
                                ) : (
                                    <button 
                                        onClick={toggleFriendRequest}
                                        className={`px-5 py-2 rounded-full border text-sm font-bold transition flex items-center gap-2 ${
                                            requestSent 
                                            ? 'bg-green-600 text-white border-green-600 hover:bg-red-600 hover:border-red-600 group' 
                                            : 'bg-indigo-600 text-white border-indigo-600 hover:bg-indigo-500'
                                        }`}
                                    >
                                        {requestSent ? (
                                            <>
                                                <span className="block group-hover:hidden flex items-center gap-2"><Check size={16}/> Sent</span>
                                                <span className="hidden group-hover:flex items-center gap-2"><X size={16}/> Cancel</span>
                                            </>
                                        ) : (
                                            <>
                                                <UserPlus size={16} /> Add Friend
                                            </>
                                        )}
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="mt-8 mx-4 bg-gray-800/50 p-4 rounded-2xl border border-gray-700/50 backdrop-blur-sm flex justify-around text-sm text-gray-400">
                        <div className="text-center">
                            <span className="block font-bold text-white text-xl">{targetUser.friends ? Object.keys(targetUser.friends).length : 0}</span> 
                            Friends
                        </div>
                        <div className="text-center">
                            <span className="block font-bold text-white text-xl">{posts.length}</span> 
                            Posts
                        </div>
                        <div className="text-center">
                            <span className="block font-bold text-white text-xl">{new Date(targetUser.joinedAt || Date.now()).getFullYear()}</span> 
                            Joined
                        </div>
                    </div>

                    <div className="px-4 mt-8 space-y-4">
                        <h3 className="font-bold text-xl text-white mb-4 border-b border-gray-800 pb-2">Posts</h3>
                        {posts.map(post => (
                            <PostCard key={post.id} post={post} currentUser={appUser} onViewProfile={()=>{}} userMap={{}} />
                        ))}
                    </div>
                </div>
            );
        }

        // FriendsView unchanged
        function FriendsView({ appUser, onViewProfile }) {
            const [activeTab, setActiveTab] = useState('my_friends'); 
            const [users, setUsers] = useState([]);
            const [requests, setRequests] = useState([]);
            const [myFriends, setMyFriends] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [allUsersMap, setAllUsersMap] = useState({});

            useEffect(() => {
                const userRef = ref(db, `users/${appUser.uid}`);
                const unsub = onValue(userRef, (snapshot) => {
                    if(snapshot.exists()) {
                        const data = snapshot.val();
                        setRequests(data.friendRequests ? Object.keys(data.friendRequests) : []);
                        setMyFriends(data.friends ? Object.keys(data.friends) : []);
                    }
                });

                const usersRef = ref(db, 'users');
                get(usersRef).then(snap => {
                    if(snap.exists()) {
                        const map = {};
                        snap.forEach(child => {
                            const u = child.val();
                            if(u.username) map[u.username] = child.key; 
                        });
                        setAllUsersMap(map);
                    }
                });

                return () => unsub();
            }, [appUser.uid]);

            useEffect(() => {
                if (activeTab === 'search') {
                    const usersRef = ref(db, 'users');
                    get(usersRef).then(snap => {
                        if(snap.exists()) {
                            const all = Object.entries(snap.val())
                                .map(([uid, val]) => ({ uid, ...val }))
                                .filter(u => u.uid !== appUser.uid);
                            setUsers(all);
                        }
                    });
                }
            }, [activeTab, appUser.uid]);

            const toggleRequest = async (targetUser) => {
                const reqRef = ref(db, `users/${targetUser.uid}/friendRequests/${appUser.username}`);
                const snap = await get(reqRef);
                
                if (snap.exists()) {
                    await remove(reqRef);
                    setUsers(prev => prev.map(u => {
                        if (u.uid === targetUser.uid) {
                            const newReqs = {...u.friendRequests};
                            delete newReqs[appUser.username];
                            return {...u, friendRequests: newReqs};
                        }
                        return u;
                    }));
                } else {
                    await set(reqRef, { username: appUser.username, uid: appUser.uid });
                    setUsers(prev => prev.map(u => {
                        if (u.uid === targetUser.uid) {
                            return {...u, friendRequests: {...u.friendRequests, [appUser.username]: true}};
                        }
                        return u;
                    }));
                    sendNotification(targetUser.uid, 'friend_request', appUser.username);
                }
            };

            const acceptRequest = async (requesterUsername) => {
                const reqDataRef = ref(db, `users/${appUser.uid}/friendRequests/${requesterUsername}`);
                const reqSnap = await get(reqDataRef);
                let requesterUid = null;
                
                if (reqSnap.exists() && reqSnap.val().uid) {
                    requesterUid = reqSnap.val().uid;
                } else {
                    const usersRef = ref(db, 'users');
                    const allSnap = await get(usersRef);
                    allSnap.forEach(child => {
                        if (child.val().username === requesterUsername) requesterUid = child.key;
                    });
                }

                if (requesterUid) {
                    const updates = {};
                    updates[`users/${appUser.uid}/friends/${requesterUsername}`] = true;
                    updates[`users/${requesterUid}/friends/${appUser.username}`] = true;
                    updates[`users/${appUser.uid}/friendRequests/${requesterUsername}`] = null;
                    await update(ref(db), updates);
                } else {
                    await set(ref(db, `users/${appUser.uid}/friends/${requesterUsername}`), true);
                    await remove(ref(db, `users/${appUser.uid}/friendRequests/${requesterUsername}`));
                }
            };

            return (
                <div className="px-4">
                    <div className="flex space-x-1 mb-6 bg-gray-800 p-1 rounded-xl">
                        {['my_friends', 'requests', 'search'].map(tab => (
                        <button 
                            key={tab}
                            onClick={() => setActiveTab(tab)} 
                            className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === tab ? 'bg-indigo-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                        >
                            {tab === 'my_friends' && 'Friends'}
                            {tab === 'requests' && `Requests ${requests.length > 0 ? `(${requests.length})` : ''}`}
                            {tab === 'search' && 'Find'}
                        </button>
                        ))}
                    </div>

                    {activeTab === 'my_friends' && (
                        <div className="space-y-3">
                            {myFriends.length === 0 && (
                                <div className="text-center py-10 text-gray-500 bg-gray-800/50 rounded-2xl border border-dashed border-gray-700">
                                    You haven't added any friends yet.
                                </div>
                            )}
                            {myFriends.map(friend => (
                                <div key={friend} className="bg-gray-800 p-4 rounded-xl flex items-center justify-between border border-gray-700">
                                    <div className="flex items-center gap-3 cursor-pointer" onClick={() => {
                                        const uid = allUsersMap[friend];
                                        if (uid) onViewProfile(uid);
                                    }}>
                                        <div className="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center font-bold text-gray-300">
                                            {friend[0].toUpperCase()}
                                        </div>
                                        <span className="font-bold text-white text-lg">@{friend}</span>
                                    </div>
                                    <span className="text-xs text-green-400 flex items-center gap-1 bg-green-400/10 px-2 py-1 rounded-full border border-green-400/20">
                                        <UserCheck size={14}/> Connected
                                    </span>
                                </div>
                            ))}
                        </div>
                    )}

                    {activeTab === 'requests' && (
                        <div className="space-y-3">
                            {requests.length === 0 && (
                                <div className="text-center py-10 text-gray-500 bg-gray-800/50 rounded-2xl border border-dashed border-gray-700">
                                    No pending requests.
                                </div>
                            )}
                            {requests.map(req => (
                                <div key={req} className="bg-gray-800 p-4 rounded-xl flex items-center justify-between border border-gray-700">
                                    <div className="flex items-center gap-3 cursor-pointer" onClick={() => {
                                        const uid = allUsersMap[req];
                                        if (uid) onViewProfile(uid);
                                    }}>
                                        <div className="w-10 h-10 rounded-full bg-indigo-900/50 flex items-center justify-center font-bold text-indigo-300">
                                            {req[0].toUpperCase()}
                                        </div>
                                        <span className="font-bold text-white">@{req}</span>
                                    </div>
                                    <button 
                                        onClick={() => acceptRequest(req)} 
                                        className="bg-indigo-600 hover:bg-indigo-500 text-white text-sm px-4 py-2 rounded-lg font-bold transition shadow-lg shadow-indigo-900/20"
                                    >
                                        Accept
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}

                    {activeTab === 'search' && (
                        <div className="space-y-4">
                            <div className="relative">
                                <Search className="absolute left-3 top-3 text-gray-500" size={18} />
                                <input 
                                    type="text" 
                                    placeholder="Search username..." 
                                    className="w-full bg-gray-800 border border-gray-700 pl-10 pr-4 py-3 rounded-xl text-white outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                            
                            <div className="space-y-3">
                                {users.filter(u => u.username && u.username.includes(searchTerm.toLowerCase())).map(u => {
                                    const isFriend = myFriends.includes(u.username);
                                    const isPending = u.friendRequests && u.friendRequests[appUser.username];
                                    
                                    return (
                                        <div key={u.uid} className="bg-gray-800 p-4 rounded-xl flex items-center justify-between border border-gray-700 hover:border-gray-600 transition">
                                            <div className="flex items-center gap-3 cursor-pointer" onClick={() => onViewProfile(u.uid)}>
                                                <div className="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center font-bold text-gray-400">
                                                    {u.username ? u.username[0].toUpperCase() : '?'}
                                                </div>
                                                <div>
                                                    <div className="font-bold text-white">{u.displayUsername}</div>
                                                    <div className="text-xs text-gray-500">@{u.username}</div>
                                                </div>
                                            </div>
                                            
                                            {isFriend ? (
                                                <span className="text-green-500 flex items-center gap-1 bg-green-500/10 px-3 py-1.5 rounded-full">
                                                    <UserCheck size={18} />
                                                </span>
                                            ) : (
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); toggleRequest(u); }}
                                                    className={`p-2 rounded-full transition ${isPending ? 'bg-green-600 text-white hover:bg-red-600 hover:text-white group' : 'bg-indigo-600/20 text-indigo-400 hover:bg-indigo-600 hover:text-white'}`}
                                                >
                                                    {isPending ? (
                                                        <>
                                                            <Check size={20} className="block group-hover:hidden" />
                                                            <X size={20} className="hidden group-hover:block" />
                                                        </>
                                                    ) : (
                                                        <UserPlus size={20} />
                                                    )}
                                                </button>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function MessagesView({ appUser }) {
            const [chats, setChats] = useState([]);
            const [activeChatUser, setActiveChatUser] = useState(null); 
            const [messages, setMessages] = useState([]);
            const [msgInput, setMsgInput] = useState('');
            const [unreadPerUser, setUnreadPerUser] = useState({});
            const [friendLastActivity, setFriendLastActivity] = useState({}); // Stores timestamp of last activity
            const scrollRef = useRef(null);

            useEffect(() => {
                const userRef = ref(db, `users/${appUser.uid}`);
                const unsub = onValue(userRef, (snapshot) => {
                    if(snapshot.exists()) {
                        const data = snapshot.val();
                        // Initialize chats list
                        setChats(data.friends ? Object.keys(data.friends) : []);
                    }
                });
                return () => unsub();
            }, [appUser.uid]);

            useEffect(() => {
                const msgRef = ref(db, 'messages');
                const unsub = onValue(msgRef, (snap) => {
                    const data = snap.val();
                    if(data) {
                        const counts = {};
                        const activityMap = {};
                        
                        Object.values(data).forEach(m => {
                            // Check unreads
                            if (m.to === appUser.username && !m.read) {
                                counts[m.from] = true;
                            }
                            // Calculate activity for sorting
                            if (m.from === appUser.username || m.to === appUser.username) {
                                const otherUser = m.from === appUser.username ? m.to : m.from;
                                if (!activityMap[otherUser] || m.createdAt > activityMap[otherUser]) {
                                    activityMap[otherUser] = m.createdAt;
                                }
                            }
                        });
                        setUnreadPerUser(counts);
                        setFriendLastActivity(activityMap);
                    } else {
                        setUnreadPerUser({});
                        setFriendLastActivity({});
                    }
                });
                return () => unsub();
            }, [appUser.username]);

            // Sorted chats
            const sortedChats = [...chats].sort((a, b) => {
                const timeA = friendLastActivity[a] || 0;
                const timeB = friendLastActivity[b] || 0;
                return timeB - timeA;
            });

            useEffect(() => {
                if (!activeChatUser) return;
                
                const msgRef = ref(db, 'messages');
                const unsub = onValue(msgRef, (snap) => {
                    const data = snap.val();
                    if(data) {
                        const entries = Object.entries(data);
                        const relevant = entries
                            .map(([id, m]) => ({ id, ...m }))
                            .filter(m => 
                                (m.from === appUser.username && m.to === activeChatUser) || 
                                (m.from === activeChatUser && m.to === appUser.username)
                            ).sort((a,b) => a.createdAt - b.createdAt);
                        setMessages(relevant);

                        // IMPORTANT: Mark messages as read IMMEDIATELY when loaded
                        const updates = {};
                        let hasUpdates = false;
                        entries.forEach(([id, m]) => {
                            if (m.from === activeChatUser && m.to === appUser.username && !m.read) {
                                updates[`messages/${id}/read`] = true;
                                hasUpdates = true;
                            }
                        });
                        
                        if (hasUpdates) {
                            update(ref(db), updates);
                        }
                    } else {
                        setMessages([]);
                    }
                    
                    setTimeout(() => {
                        if(scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                    }, 100);
                });
                return () => unsub();
            }, [activeChatUser, appUser]);

            const sendMessage = async () => {
                if (!msgInput.trim() || !activeChatUser) return;
                const txt = msgInput;
                setMsgInput(''); 
                const newMsgRef = push(ref(db, 'messages'));
                await set(newMsgRef, {
                    from: appUser.username,
                    to: activeChatUser,
                    content: txt,
                    createdAt: Date.now(),
                    read: false
                });
            };

            if (activeChatUser) {
                return (
                    <div className="flex flex-col h-[calc(100vh-140px)] md:h-[calc(100vh-100px)] bg-gray-900 md:rounded-2xl md:border md:border-gray-700 overflow-hidden mx-0 md:mx-4">
                        <div className="flex items-center p-4 bg-gray-800 border-b border-gray-700">
                            <button onClick={() => setActiveChatUser(null)} className="mr-4 text-gray-400 hover:text-white p-1 rounded-lg hover:bg-gray-700">
                                <X size={20} />
                            </button>
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center font-bold text-xs">
                                    {activeChatUser[0].toUpperCase()}
                                </div>
                                <div className="font-bold text-lg">@{activeChatUser}</div>
                            </div>
                        </div>
                        
                        <div ref={scrollRef} className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-900 scrollbar-thin scrollbar-thumb-gray-800">
                            {messages.map(m => {
                                const isMe = m.from === appUser.username;
                                return (
                                    <div key={m.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[75%] rounded-2xl px-4 py-2 text-sm shadow-sm ${isMe ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-gray-800 text-gray-200 rounded-bl-none border border-gray-700'}`}>
                                            <p>{m.content}</p>
                                            <p className={`text-[9px] mt-1 text-right ${isMe ? 'text-indigo-200' : 'text-gray-500'}`}>{formatTime(m.createdAt)}</p>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        <div className="p-3 bg-gray-800 flex gap-2 border-t border-gray-700">
                            <input 
                                className="flex-1 bg-gray-900 text-white rounded-xl px-4 py-2 outline-none border border-gray-700 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition"
                                placeholder="Type a message..."
                                value={msgInput}
                                onChange={e => setMsgInput(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && sendMessage()}
                            />
                            <button onClick={sendMessage} className="p-2 bg-indigo-600 rounded-xl text-white hover:bg-indigo-500 transition shadow-lg">
                                <Send size={20} />
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="px-4">
                    <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
                        Messages
                        <span className="text-sm font-normal text-gray-500 bg-gray-800 px-2 py-0.5 rounded-full">{sortedChats.length}</span>
                    </h2>
                    <div className="space-y-3">
                        {sortedChats.length === 0 && (
                            <div className="text-center py-12 text-gray-500 bg-gray-800/30 rounded-2xl border border-dashed border-gray-700">
                                <UserPlus className="mx-auto mb-2 opacity-50" />
                                Add friends to start chatting!
                            </div>
                        )}
                        {sortedChats.map(friend => (
                            <div 
                                key={friend} 
                                onClick={() => setActiveChatUser(friend)}
                                className="bg-gray-800 p-4 rounded-xl flex items-center justify-between cursor-pointer hover:bg-gray-750 hover:border-gray-600 border border-gray-700 transition group relative"
                            >
                                <div className="flex items-center gap-4">
                                    <div className="w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-gray-300 font-bold text-lg group-hover:bg-indigo-600 group-hover:text-white transition-colors relative">
                                        {friend[0].toUpperCase()}
                                        {unreadPerUser[friend] && (
                                            <span className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-gray-800 animate-pulse"></span>
                                        )}
                                    </div>
                                    <div>
                                        <span className="font-bold text-lg text-gray-200">@{friend}</span>
                                        <p className="text-xs text-gray-500">Tap to chat</p>
                                    </div>
                                </div>
                                <MessageSquare size={20} className="text-gray-600 group-hover:text-indigo-400 transition" />
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function NotificationsView({ appUser, onViewPost }) {
            const [notifs, setNotifs] = useState([]);

            useEffect(() => {
                const notifRef = ref(db, `notifications/${appUser.uid}`);
                const unsub = onValue(notifRef, (snap) => {
                    const data = snap.val();
                    if(data) {
                        const list = Object.entries(data)
                            .map(([id, val]) => ({ id, ...val }))
                            .sort((a,b) => b.createdAt - a.createdAt);
                        setNotifs(list);
                    } else {
                        setNotifs([]);
                    }
                });
                return () => unsub();
            }, [appUser.uid]);

            const getIcon = (type) => {
                switch(type) {
                    case 'like': return <Heart size={16} className="text-pink-500 fill-pink-500" />;
                    case 'comment_like': return <Heart size={16} className="text-pink-400" />;
                    case 'comment': return <MessageCircle size={16} className="text-blue-400" />;
                    case 'friend_request': return <UserPlus size={16} className="text-green-400" />;
                    case 'friend_accept': return <UserCheck size={16} className="text-green-400" />;
                    case 'mention': return <AtSign size={16} className="text-yellow-400" />;
                    default: return <Bell size={16} />;
                }
            };

            const getText = (n) => {
                switch(n.type) {
                    case 'like': return `liked your post.`;
                    case 'comment_like': return `liked your comment.`;
                    case 'comment': return `commented: "${n.commentText || '...'}"`;
                    case 'friend_request': return `sent you a friend request.`;
                    case 'friend_accept': return `accepted your friend request.`;
                    case 'mention': return `mentioned you in a post.`;
                    default: return 'interacted with you.';
                }
            };

            const handleClick = (n) => {
                // Mark as read when clicked
                update(ref(db, `notifications/${appUser.uid}/${n.id}`), { read: true });

                if (n.contentId && (n.type === 'like' || n.type === 'comment' || n.type === 'mention')) {
                    onViewPost(n.contentId);
                }
            };

            return (
                <div className="px-4">
                    <h2 className="text-2xl font-bold mb-6">Notifications</h2>
                    <div className="space-y-3">
                        {notifs.length === 0 && (
                            <div className="text-center py-12 text-gray-500 bg-gray-800/30 rounded-2xl border border-dashed border-gray-700">
                                No new notifications.
                            </div>
                        )}
                        {notifs.map(n => (
                            <div 
                                key={n.id} 
                                onClick={() => handleClick(n)}
                                className={`bg-gray-800 p-4 rounded-xl flex items-center gap-4 border-l-4 ${n.read ? 'border-gray-700 opacity-75' : 'border-indigo-500'} shadow-sm cursor-pointer hover:bg-gray-750`}
                            >
                                <div className="p-3 bg-gray-900 rounded-full border border-gray-700 relative">
                                    {getIcon(n.type)}
                                    {!n.read && <span className="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border border-gray-800"></span>}
                                </div>
                                <div>
                                    <p className="text-gray-200">
                                        <span className="font-bold text-indigo-300">@{n.from}</span> {getText(n)}
                                    </p>
                                    <p className="text-xs text-gray-500 mt-1">{new Date(n.createdAt).toLocaleDateString()} at {new Date(n.createdAt).toLocaleTimeString()}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // Profile, SinglePostView same as before ... 
        function Profile({ appUser, isMyProfile, onViewProfile }) {
            // (Same implementation as before)
            const [posts, setPosts] = useState([]);
            const [isEditingProfile, setIsEditingProfile] = useState(false);
            const [editDisplayName, setEditDisplayName] = useState(appUser.displayUsername || '');
            const [editBio, setEditBio] = useState(appUser.bio || '');
            const [showFriendList, setShowFriendList] = useState(false);
            const [friendsList, setFriendsList] = useState([]);

            useEffect(() => {
                const postsRef = ref(db, 'posts');
                const unsub = onValue(postsRef, (snapshot) => {
                    const data = snapshot.val();
                    if(data) {
                        const list = Object.entries(data)
                            .map(([id, val]) => ({ id, ...val }))
                            .filter(p => p.author === appUser.username)
                            .sort((a, b) => b.createdAt - a.createdAt);
                        setPosts(list);
                    } else {
                        setPosts([]);
                    }
                });
                return () => unsub();
            }, [appUser.username]);

            const handleSaveProfile = async () => {
                if (!editDisplayName.trim()) return;
                try {
                    await update(ref(db, `users/${appUser.uid}`), { displayUsername: editDisplayName, bio: editBio });
                    if (auth.currentUser) await updateProfile(auth.currentUser, { displayName: editDisplayName });
                    setIsEditingProfile(false);
                } catch (error) { console.error("Failed to update profile", error); }
            };

            const handleShowFriends = async () => {
                if (!isMyProfile) return;
                const friendUsernames = appUser.friends ? Object.keys(appUser.friends) : [];
                if (friendUsernames.length === 0) return;
                const usersRef = ref(db, 'users');
                const snap = await get(usersRef);
                if (snap.exists()) {
                    const allUsers = snap.val();
                    const friendsData = Object.entries(allUsers).map(([uid, u]) => ({ uid, ...u })).filter(u => friendUsernames.includes(u.username));
                    setFriendsList(friendsData);
                    setShowFriendList(true);
                }
            };

            const nameStyle = appUser.username.toLowerCase() === 'tuntun' ? { color: '#FFD700', textShadow: '0 0 5px rgba(255, 215, 0, 0.5)' } : {};

            return (
                <div className="min-h-screen pb-10">
                    {showFriendList && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                            <div className="bg-gray-800 rounded-2xl p-6 w-full max-w-md border border-gray-700 shadow-2xl h-[400px] flex flex-col">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><Users size={20} /> My Friends</h2>
                                    <button onClick={() => setShowFriendList(false)} className="text-gray-400 hover:text-white"><X size={20} /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto space-y-2">
                                    {friendsList.map(friend => (
                                        <div key={friend.uid} onClick={() => { setShowFriendList(false); onViewProfile(friend.uid); }} className="flex items-center gap-3 p-3 hover:bg-gray-700 rounded-xl cursor-pointer transition">
                                            <div className="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center font-bold text-white">{friend.username[0].toUpperCase()}</div>
                                            <div><div className="font-bold text-white">{friend.displayUsername}</div><div className="text-xs text-gray-400">@{friend.username}</div></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                    {isEditingProfile && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                            <div className="bg-gray-800 rounded-2xl p-6 w-full max-w-md border border-gray-700 shadow-2xl">
                                <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Edit2 size={20} /> Edit Profile</h2>
                                <div className="space-y-4">
                                    <div><label className="block text-sm text-gray-400 mb-1">Display Name</label><input type="text" className="w-full bg-gray-900 border border-gray-600 rounded-lg p-2.5 text-white focus:border-indigo-500 outline-none" value={editDisplayName} onChange={(e) => setEditDisplayName(e.target.value)} /></div>
                                    <div><label className="block text-sm text-gray-400 mb-1">Bio</label><textarea className="w-full bg-gray-900 border border-gray-600 rounded-lg p-2.5 text-white focus:border-indigo-500 outline-none h-24 resize-none" value={editBio} onChange={(e) => setEditBio(e.target.value)} placeholder="Tell us about yourself..." /></div>
                                </div>
                                <div className="flex justify-end gap-3 mt-6">
                                    <button onClick={() => setIsEditingProfile(false)} className="px-4 py-2 text-gray-300 hover:text-white">Cancel</button>
                                    <button onClick={handleSaveProfile} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg flex items-center gap-2"><Save size={16} /> Save Changes</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="relative">
                        <div className="h-40 bg-gradient-to-r from-indigo-900 via-purple-900 to-gray-900 rounded-b-3xl mx-[-1rem] md:mx-0 md:rounded-t-2xl relative overflow-hidden"><div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20"></div></div>
                        <div className="px-4 -mt-16 relative z-10 flex flex-col items-center md:items-start md:flex-row md:gap-6">
                            <div className="w-32 h-32 rounded-full bg-gray-900 p-1.5 shadow-2xl"><div className="w-full h-full rounded-full bg-gradient-to-br from-indigo-600 to-indigo-800 flex items-center justify-center text-4xl font-bold text-white shadow-inner">{appUser.username ? appUser.username[0].toUpperCase() : '?'}</div></div>
                            <div className="mt-4 md:mt-16 text-center md:text-left flex-1"><h1 className="text-3xl font-bold text-white tracking-tight" style={nameStyle}>{appUser.displayUsername || appUser.username}</h1><p className="text-indigo-400 font-medium">@{appUser.username}</p>{appUser.bio && (<p className="text-gray-400 text-sm mt-2 max-w-md mx-auto md:mx-0 italic border-l-2 border-indigo-500/50 pl-3">{appUser.bio}</p>)}</div>
                            {isMyProfile && (<div className="mt-4 md:mt-16"><button onClick={() => setIsEditingProfile(true)} className="bg-gray-800 hover:bg-gray-700 px-5 py-2 rounded-full border border-gray-600 text-sm font-medium transition shadow-sm flex items-center gap-2"><Edit2 size={14} /> Edit Profile</button></div>)}
                        </div>
                    </div>
                    <div className="mt-8 mx-4 bg-gray-800/50 p-4 rounded-2xl border border-gray-700/50 backdrop-blur-sm flex justify-around text-sm text-gray-400">
                        <div className={`text-center ${isMyProfile ? 'cursor-pointer hover:bg-gray-700/50 rounded-lg p-1 transition' : ''}`} onClick={handleShowFriends}><span className="block font-bold text-white text-xl">{appUser.friends ? Object.keys(appUser.friends).length : 0}</span> Friends</div>
                        <div className="text-center"><span className="block font-bold text-white text-xl">{posts.length}</span> Posts</div>
                        <div className="text-center"><span className="block font-bold text-white text-xl">{new Date(appUser.joinedAt || Date.now()).getFullYear()}</span> Joined</div>
                    </div>
                    <div className="px-4 mt-8 space-y-4">
                        <h3 className="font-bold text-xl text-white mb-4 flex items-center gap-2 pb-2 border-b border-gray-800"><Sparkles size={20} className="text-yellow-500" /> Recent Activity</h3>
                        {posts.map(post => (<PostCard key={post.id} post={post} currentUser={appUser} onViewProfile={onViewProfile} />))}
                        {posts.length === 0 && (<div className="text-center py-16 text-gray-500 bg-gray-800/30 rounded-2xl border border-dashed border-gray-700 flex flex-col items-center gap-2"><MessageSquare size={32} className="opacity-20" /><span>No activity yet.</span></div>)}
                    </div>
                </div>
            );
        }

        function SinglePostView({ postId, appUser, onBack, onViewProfile }) {
            const [post, setPost] = useState(null);
            useEffect(() => { if (!postId) return; get(ref(db, `posts/${postId}`)).then(snap => { if (snap.exists()) { setPost({ id: postId, ...snap.val() }); } }); }, [postId]);
            if (!post) return (<div className="h-screen w-full flex flex-col items-center justify-center bg-gray-900 text-white gap-4"><LoadingSpinner /><span className="font-medium tracking-widest text-sm text-gray-400">LOADING POST...</span></div>);
            return (<div className="min-h-screen pb-10"><div className="relative h-16 bg-gray-800 border-b border-gray-700 flex items-center px-4"><button onClick={onBack} className="bg-black/50 p-2 rounded-full text-white hover:bg-black/70"><ArrowLeft size={20} /></button><span className="ml-4 font-bold text-white">View Post</span></div><div className="p-4"><PostCard post={post} currentUser={appUser} onViewProfile={onViewProfile} /></div></div>);
        }

        // --- Main Component ---
        function App() {
            const [user, setUser] = useState(null);
            const [appUserProfile, setAppUserProfile] = useState(null);
            const [viewingUser, setViewingUser] = useState(null); 
            const [viewingPostId, setViewingPostId] = useState(null);
            const [view, setView] = useState('auth'); 
            const [loading, setLoading] = useState(true);
            const [userMap, setUserMap] = useState({});
            
            // Notification Counters
            const [unreadNotifs, setUnreadNotifs] = useState(false);
            const [unreadMessages, setUnreadMessages] = useState(false);
            
            // Friend Request Logic
            const [hasNewFriendReqs, setHasNewFriendReqs] = useState(false);
            const [seenReqCount, setSeenReqCount] = useState(0);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (firebaseUser) => {
                    if (firebaseUser) {
                        setUser(firebaseUser);
                        
                        try {
                            const userRef = ref(db, `users/${firebaseUser.uid}`);
                            onValue(userRef, (snapshot) => {
                                if (snapshot.exists()) {
                                    const data = snapshot.val();
                                    setAppUserProfile({ 
                                        uid: firebaseUser.uid, 
                                        ...data,
                                        username: data.username || firebaseUser.displayName || 'Anonymous',
                                        displayUsername: data.displayUsername || firebaseUser.displayName || 'Anonymous'
                                    });

                                    // Handle friend request badge
                                    const reqCount = data.friendRequests ? Object.keys(data.friendRequests).length : 0;
                                    // If we have more requests than we've seen, show badge
                                    if (reqCount > seenReqCount) {
                                        setHasNewFriendReqs(true);
                                    } else if (reqCount === 0) {
                                        setHasNewFriendReqs(false);
                                        setSeenReqCount(0);
                                    }
                                } else {
                                    setAppUserProfile({
                                        uid: firebaseUser.uid,
                                        username: firebaseUser.displayName || 'Anonymous',
                                        displayUsername: firebaseUser.displayName || 'Anonymous',
                                        friends: [],
                                        bio: "New to Anti Isrt"
                                    });
                                }
                                if (view === 'auth') setView('home');
                                setLoading(false);
                            });

                            // Fetch User Map
                            get(ref(db, 'users')).then(snap => {
                                if(snap.exists()) {
                                    const map = {};
                                    snap.forEach(child => {
                                        const u = child.val();
                                        if(u.username) map[u.username] = child.key;
                                    });
                                    setUserMap(map);
                                }
                            }).catch(err => {
                                console.log("Global user fetch prevented or failed:", err.code);
                            });

                        } catch (error) {
                            console.error("Profile load error", error);
                            setLoading(false);
                        }

                        // Notifications Check
                        const notifRef = ref(db, `notifications/${firebaseUser.uid}`);
                        onValue(notifRef, (snap) => {
                            if (snap.exists()) {
                                const vals = Object.values(snap.val());
                                const hasUnread = vals.some(n => n.read === false);
                                setUnreadNotifs(hasUnread);
                            } else {
                                setUnreadNotifs(false);
                            }
                        });

                        // Messages Check
                        const msgRef = ref(db, 'messages');
                        onValue(msgRef, (snap) => {
                            if (snap.exists()) {
                                const vals = Object.values(snap.val());
                                const myUsername = appUserProfile ? appUserProfile.username : firebaseUser.displayName;
                                
                                if (myUsername) {
                                    const hasUnread = vals.some(m => 
                                        m.to === myUsername && 
                                        m.read === false &&
                                        m.from !== myUsername
                                    );
                                    setUnreadMessages(hasUnread);
                                }
                            }
                        });

                    } else {
                        setUser(null);
                        setAppUserProfile(null);
                        setView('auth');
                        setLoading(false);
                    }
                });

                return () => unsubscribe();
            }, []); // appUserProfile is not dependency here to avoid infinite loop with the ref

            const handleLogout = async () => {
                await firebaseSignOut(auth);
                setView('auth');
            };

            const handleViewProfile = async (targetUid) => {
                if (!user) return;
                if (targetUid === user.uid) {
                    setView('profile');
                    return;
                }
                
                setLoading(true);
                try {
                    const snapshot = await get(ref(db, `users/${targetUid}`));
                    if (snapshot.exists()) {
                        setViewingUser({ uid: targetUid, ...snapshot.val() });
                        setView('other_profile');
                    }
                } catch (e) {
                    console.error("Error fetching user:", e);
                }
                setLoading(false);
            };

            const handleViewPost = (postId) => {
                setViewingPostId(postId);
                setView('single_post');
            };

            const switchView = (newView) => {
                setView(newView);
                // Clear friend badge if opening friends
                if (newView === 'friends' && appUserProfile) {
                    setHasNewFriendReqs(false);
                    const currentReqs = appUserProfile.friendRequests ? Object.keys(appUserProfile.friendRequests).length : 0;
                    setSeenReqCount(currentReqs);
                }
            };

            if (loading) {
                return (
                    <div className="h-screen w-full flex flex-col items-center justify-center bg-gray-900 text-white gap-4">
                        <LoadingSpinner />
                        <span className="font-medium tracking-widest text-sm text-gray-400">CONNECTING...</span>
                    </div>
                );
            }

            if (!user || !appUserProfile) {
                return <AuthScreen />;
            }

            return (
                <div className="flex flex-col h-screen bg-gray-900 text-gray-100 font-sans overflow-hidden">
                    <header className="flex-none h-16 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 z-20 shadow-md">
                        <div className="flex items-center space-x-2 cursor-pointer" onClick={() => switchView('home')}>
                            <div className="w-8 h-8 bg-red-600 rounded-lg flex items-center justify-center shadow-lg shadow-red-900/50">
                                <X size={24} className="text-white" strokeWidth={4} />
                            </div>
                            <span className="font-bold text-lg tracking-tight text-white">Anti Isrt</span>
                        </div>
                        
                        <div className="flex items-center space-x-3">
                            <button 
                                onClick={() => switchView('profile')} 
                                className="flex items-center space-x-2 hover:bg-gray-700 py-1 px-2 rounded-full transition border border-transparent hover:border-gray-600"
                            >
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold shadow-inner ${appUserProfile.username.toLowerCase() === 'tuntun' ? 'bg-yellow-500 text-black border-2 border-yellow-200' : 'bg-indigo-500 text-white'}`}>
                                    {appUserProfile.username ? appUserProfile.username[0].toUpperCase() : '?'}
                                </div>
                                <span className="font-medium text-sm text-gray-200 max-w-[100px] truncate" style={appUserProfile.username.toLowerCase() === 'tuntun' ? { color: '#FFD700' } : {}}>{appUserProfile.displayUsername}</span>
                            </button>

                            <button onClick={handleLogout} className="md:hidden p-2 text-red-400 hover:bg-red-500/10 rounded-full transition">
                                <LogOut size={20} />
                            </button>
                        </div>
                    </header>

                    <div className="md:hidden flex-none h-12 bg-gray-800 border-b border-gray-700 flex justify-around items-center px-1 z-10 shadow-sm">
                        <MobileNavButton icon={Home} active={view === 'home'} onClick={() => switchView('home')} />
                        <MobileNavButton icon={UserPlus} active={view === 'friends'} onClick={() => switchView('friends')} hasBadge={hasNewFriendReqs} />
                        <MobileNavButton icon={MessageSquare} active={view === 'messages'} onClick={() => switchView('messages')} hasBadge={unreadMessages} />
                        <MobileNavButton icon={Bell} active={view === 'notifications'} onClick={() => switchView('notifications')} hasBadge={unreadNotifs} />
                    </div>

                    <div className="flex flex-1 overflow-hidden relative">
                        <aside className="hidden md:flex flex-col w-64 bg-gray-800/50 border-r border-gray-700 pt-6 backdrop-blur-sm">
                            <NavButton icon={Home} label="Home" active={view === 'home'} onClick={() => switchView('home')} />
                            <NavButton icon={UserPlus} label="Friends" active={view === 'friends'} onClick={() => switchView('friends')} hasBadge={hasNewFriendReqs} />
                            <NavButton icon={MessageSquare} label="Messages" active={view === 'messages'} onClick={() => switchView('messages')} hasBadge={unreadMessages} />
                            <NavButton icon={Bell} label="Notifications" active={view === 'notifications'} onClick={() => switchView('notifications')} hasBadge={unreadNotifs} />
                            <NavButton icon={User} label="Profile" active={view === 'profile'} onClick={() => switchView('profile')} />
                            <div className="mt-auto mb-6 px-4">
                                <button onClick={handleLogout} className="flex items-center gap-3 text-red-400 hover:text-red-300 hover:bg-red-500/10 w-full px-4 py-3 rounded-xl transition-all font-medium">
                                    <LogOut size={20} />
                                    <span>Log Out</span>
                                </button>
                            </div>
                        </aside>

                        <main className="flex-1 overflow-y-auto bg-gray-900 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-transparent relative w-full">
                            <div className="max-w-2xl mx-auto w-full pb-20 md:pb-8 pt-4 md:pt-8 px-0 md:px-4">
                                {view === 'home' && <HomeFeed appUser={appUserProfile} onViewProfile={handleViewProfile} userMap={userMap} />}
                                {view === 'profile' && <Profile appUser={appUserProfile} isMyProfile={true} onViewProfile={handleViewProfile} />}
                                {view === 'other_profile' && <OtherUserProfile appUser={appUserProfile} targetUser={viewingUser} onBack={() => switchView('home')} />}
                                {view === 'friends' && <FriendsView appUser={appUserProfile} onViewProfile={handleViewProfile} />}
                                {view === 'messages' && <MessagesView appUser={appUserProfile} />}
                                {view === 'notifications' && <NotificationsView appUser={appUserProfile} onViewPost={handleViewPost} />}
                                {view === 'single_post' && <SinglePostView postId={viewingPostId} appUser={appUserProfile} onBack={() => switchView('home')} onViewProfile={handleViewProfile} />}
                            </div>
                        </main>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
